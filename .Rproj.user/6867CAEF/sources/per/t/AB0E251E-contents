---
title: "Documentation of HyADS to PM~2.5~ conversion"
author: "Lucas Henneman"
date: "9/12/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)

library( hyspdisp)
library( ggplot2)
library( viridis)
library( cowplot)

load( '~/Dropbox/Harvard/RFMeval_Local/HyADS_to_PM25/RData/cmaqddm_to_pm25_crossval.RData')
```

## Introduction
HyADS, the HYSPLIT Average Dispersion model, identifies areas exposed to emissions from point sources. The defailt model output is a unitless measure of influece that is difficult to interpret. As shown in our previous work, this measure of influence is highly correlated with Hybrid CMAQ-DDM based PM~2.5~ source impacts [cites].

To improve the overall interpretability of HyADS, we seek to develop an approach to convert the HyADS metric to the more familiar $\mu$g$\,$m$^{-3}$. We use the assumptions that:

1. on a sufficiently long-term basis, HyADS emissions either deposit or are converted to PM~2.5~, which has strong support for SO~2~ emissions.
2. on an average basis, the hybrid CMAQ-DDM source impacts represent the same sources as HyADS, even if some small local sources may be included in CMAQ-DDM but not HyADS

## Data
### HyADS
We ran HyADS for all XX units operating in 2005 and YY units operating in 2006, then linked the output to a 12km x 12km grid. Monthly parcel counts in each grid cell were weighted by each unit's monthly SO~2~ emissions, and the weighted counts were aggregated to monthly and annual values.

```{r, hyads, fig.width = 10, fig.asp = .35}
ggplot.a.raster( dats2005.s$hyads, dats2006.s$hyads, bounds = c( 0, 800000),
                 facet.names = c( 'HyADS - 2005', 'HyADS - 2006'))
```


### CMAQ-DDM
Daily Hybrid CMAQ-DDM modeled coal emissions contributions to PM~2.5~ were retrieved from Ivey et al.~(date, citation) and aggregated to annual values.

```{r, ddm, fig.width = 10, fig.asp = .35}
ggplot.a.raster( dats2005.s$cmaq.ddm, dats2006.s$cmaq.ddm, bounds = c( 0, 5),
                 facet.names = c( 'Hybrid CMAQ-DDM - 2005', 'Hybrid CMAQ-DDM - 2006'))
```


### Meteorology data
Cite NARR data, provide function to download

```{r, met, fig.width = 10, fig.asp = .65}
plot_grid(ggplot.a.raster( dats2005.s$temp, bounds = c( 0, NA),
                           facet.names = '2005 Temperature - K'),
          ggplot.a.raster( dats2005.s$apcp, bounds = c( 0, 6),
                           facet.names = '2005 Precip - kg m^{-2}'),
          ggplot.a.raster( dats2005.s$rhum, bounds = c( 30, 80),
                           facet.names = '2005 Relative humidity - %'),
          ggplot.a.raster( dats2005.s$wspd, bounds = c( 0, 3.5),
                           facet.names = '2005 Windspeed - m/s'),
          ncol = 2, nrow = 2,
          labels = NULL, align = 'v', axis = 'lr')

```

## Model


### Set-up

### Evaluation

#### Holdout evaluation
We ran 500 iterations of a hold-ten-percent out cross-validation. Here are the NMB, NME, MB, RMSE, and R values for the evaluation.

```{r evaluation, fig.width = 7, fig.asp = 1}
metrics.out <- rbindlist( lapply( single.crossval, '[[', 'metrics'))
metrics.out.m <- melt( metrics.out, id.vars = 'mod.name')
metrics.means <- metrics.out.m[, .( med = median( value)), by = .( mod.name, variable)]

ggplot( data = metrics.out.m[ mod.name %ni% 'adj.mean']) +
  facet_wrap( . ~ variable, ncol = 1, scales = 'free') +
  labs( x = NULL, y = 'Density') +
  scale_color_discrete( name = 'Model Name') +
  geom_density( aes( x = value, color = mod.name)) + 
  geom_vline( data = metrics.means[ mod.name %ni% 'adj.mean'], 
              aes( xintercept = med, color = mod.name),
              lty = 2) 


```

We averaged predicted values for the holdout evaluations and subtracted from 2005 y values:
```{r yhatbar, fig.width = 5, fig.asp = .65}
yhatbar2005 <- mean.lol( single.crossval, 'Y.ho.hat.bias.raster', 'y.hat.lm.cv', 
                         plot = F)
ggplot.a.raster( yhatbar2005, bounds = c( -3, 3),
                 facet.names = c( 'Yhatbar - Hybrid CMAQ-DDM'))

```


#### Annual prediction
Need to figure out what's going on at the edges
```{r yhat2006, fig.width = 10, fig.asp = .35}
ggplot.a.raster( pred2006$Y.ho.hat.raster$y.hat.lm.cv,
                 dats2006.s$cmaq.ddm, bounds = c( 0,5),
                 facet.names = c( 'Yhat', 'Hybrid CMAQ-DDM'))

```

```{r yhatminusy, fig.width = 5, fig.asp = .65}
ggplot.a.raster( pred2006$Y.ho.hat.raster$y.hat.lm.cv - 
                 dats2006.s$cmaq.ddm, bounds = c( -2,2),
                 facet.names = c( 'Yhat - Hybrid CMAQ-DDM'))

```

## Discussion
It's a matter of entrusting HyADS to get the spatial pattern correct and CMAQ-DDM to get the mean value correct. 

## Future
include option to convert HyADS to ugm3 with or without meteorological covariates [DisperseR](https://github.com/garbulinskamaja/disperseR)

